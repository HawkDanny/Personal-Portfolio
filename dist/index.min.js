"use strict";function init(){lyrics=[],populateLyrics(),images=[],areImagesLoaded=!1,numImagesLoaded=0,loadImages(),imageData=[],areImagesPrepped=!1,state=STATE.TITLE,songState=SONG_STATE.INTRO,canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),canvas.width=800,canvas.height=800,fontSizeMin=8,fontSizeMax=24,kerning=2,lineheight=8,initAudio(),update()}function populateLyrics(){lyrics[0]="You'll notice yourself smiling with delight over things you once paid no attention to ",lyrics[1]="Streetlights on the river ",lyrics[2]="Smoke rising from a chimney ",lyrics[3]="Red roofs in the trees ",lyrics[4]="My dog's eyes ",lyrics[5]="Water being cut at the bow of a boat ",lyrics[6]="Looking into deep, clear water ",lyrics[7]="velvet Red ",lyrics[8]="The moon in the clouds ",lyrics[9]="These were children who hadn't yet lost their sense of wonder ",lyrics[10]="They hadn't become unseeing, and unfeeling ",lyrics[11]="A fast train rushing ",lyrics[12]="If children were asked the same question today ",lyrics[13]="Their answers would reflect a more mechanized world ",lyrics[14]="But I'm sure they'd still have that sense of wonder "}function loadImages(){images[0]=new Image,images[0].src="media/start.png",images[1]=new Image,images[1].src="media/river.jpg",images[2]=new Image,images[2].src="media/chimney.jpg",images[3]=new Image,images[3].src="media/redroof.jpg",images[4]=new Image,images[4].src="media/dog.jpg",images[5]=new Image,images[5].src="media/start.png",images[6]=new Image,images[6].src="media/water.jpg",images[7]=new Image,images[7].src="media/redvelvet.jpg",images[8]=new Image,images[8].src="media/moon.jpg",images[9]=new Image,images[9].src="media/start.png",images[10]=new Image,images[10].src="media/start.png",images[11]=new Image,images[11].src="media/train.jpg",images[12]=new Image,images[12].src="media/start.png",images[13]=new Image,images[13].src="media/start.png",images[14]=new Image,images[14].src="media/start.png";for(var e=0;e<images.length;e++)images[e].width=800,images[e].height=800,images[e].addEventListener("load",function(){++numImagesLoaded})}function populateImageData(){for(var e=0;e<images.length;e++){var a=images[e],t=document.createElement("canvas"),i=t.getContext("2d");t.width=a.width,t.height=a.height,i.drawImage(a,0,0);for(var g=i.getImageData(0,0,a.width,a.height),n=[],s=0;s<g.data.length;s+=4)n[s/4]={r:g.data[s],g:g.data[s+1],b:g.data[s+2],a:g.data[s+3]};imageData[e]=n}areImagesPrepped=!0}function checkImages(){numImagesLoaded===images.length&&(areImagesLoaded=!0)&&!areImagesPrepped&&populateImageData()}function initAudio(){audio=new AudioManager,audioTag=document.querySelector("audio"),audioDecimator=0}function update(){switch(window.requestAnimationFrame(update),ctx.clearRect(0,0,canvas.width,canvas.height),state){case STATE.TITLE:updateTitle();break;case STATE.LOADING:updateLoading();break;case STATE.SONG:updateSong();break;case STATE.END:updateEnd()}}function updateTitle(){ctx.baseline="middle",ctx.textAlign="center",ctx.fillText("MY DOG'S EYES",canvas.width/2,canvas.height/2),checkImages(),myKeys.keydown[32]&&(areImagesPrepped?(audio.startSong(),state=STATE.SONG):state=STATE.LOADING)}function updateLoading(){ctx.baseline="middle",ctx.textAlign="center",ctx.fillText("LOADING",canvas.width/2,canvas.height/2),checkImages(),areImagesPrepped&&(audio.startSong(),state=STATE.SONG)}function updateSong(){switch(updateAudioData(),songState){case 0:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>5&&++songState;break;case 1:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>25&&++songState;break;case 2:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>38&&++songState;break;case 3:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>50&&++songState;break;case 4:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>62&&++songState;break;case 5:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>71&&++songState;break;case 6:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>76&&++songState;break;case 7:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>88&&++songState;break;case 8:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>101&&++songState;break;case 9:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>114&&++songState;break;case 10:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>126&&++songState;break;case 11:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>153&&++songState;break;case 12:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>160&&++songState;break;case 13:renderTextAsImage(images[songState],imageData[songState]),audioTag.currentTime>174&&++songState;break;case 14:renderTextAsImage(images[songState],imageData[songState])}}function updateEnd(){ctx.baseline="middle",ctx.textAlign="center",ctx.fillText("THE END",canvas.width/2,canvas.height/2),myKeys.keydown[32]&&(state=STATE.TITLE)}function updateAudioData(){if(audioDecimator%10==1){audio.update(),audioData=audio.getData(),kickFreq=0;for(var e=0;e<audioData.length/4;e++)kickFreq+=audioData[e];kickFreq/=audioData.length/4}++audioDecimator}function renderTextAsImage(e,a){ctx.textAlign="left";for(var t=0,i=10,g=0;i<canvas.height;){var n=map_range(t,0,canvas.width,0,e.width),s=map_range(i,0,canvas.height,0,e.height),r=a[s*e.width+Math.floor(n)],o=Math.floor(.222*r.r+.707*r.g+.071*r.b),m=map_range(o,0,255,fontSizeMin,fontSizeMax);m+=map_range(kickFreq,0,256,0,10),m=Math.max(m,1),ctx.font=m+"px Courier",ctx.fillStyle="rgb("+r.r+", "+r.g+", "+r.b+")";var d=getCurrentLetter(g);ctx.fillText(d,t,i);t+=ctx.measureText(d).width+kerning,t>=canvas.width&&(t=0,i+=lineheight),++g}}function getCurrentLetter(e){var a=lyrics[songState];return a[e%a.length]}function map_range(e,a,t,i,g){return i+(g-i)*(e-a)/(t-a)}var STATE={TITLE:0,LOADING:1,SONG:2,END:3},SONG_STATE={INTRO:0,STREETLIGHTS:1,CHIMNEY:2,REDROOFS:3,DOGSEYES:4,BOAT:5,WATER:6,VELVET:7,MOON:8,WONDER:9,UNSEEING:10,TRAIN:11,QUESTION:12,MECHANIZED:13,IM_SURE:14},lyrics=void 0,images=void 0,imageData=void 0,areImagesLoaded=void 0,numImagesLoaded=void 0,areImagesPrepped=void 0,state=void 0,songState=void 0,canvas=void 0,ctx=void 0,audio=void 0,audioTag=void 0,audioData=void 0,audioDecimator=void 0,kickFreq=void 0,fontSizeMin=void 0,fontSizeMax=void 0,kerning=void 0,lineheight=void 0;window.onload=init;